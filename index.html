<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikBok - Infinite swipe short video</title>
    <style>
        html,
        body {
            background-color: #151724;
            justify-content: center;
            display: flex;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        .slide-list {
            display: block;
            /* height: 100%; */
            height: calc(var(--vh) * 100);
            width: 50vw;
            transition: transform 0.3s ease;
            /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
            position: relative;
        }

        .frame {
            position: relative;
            background-color: black;
        }

        video {
            height: 100%;
            width: 100%;
            object-fit: contain;
        }

        /* æ·»åŠ playæŒ‰é’®æ ·å¼ */
        .play-icon {
            display: none;
            /* é»˜è®¤éšè— */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6%;
            /* æ ¹æ®è§†å£å®½åº¦è°ƒæ•´å¤§å° */
            height: auto;
            /* æ ¹æ®å®½åº¦ç­‰æ¯”ä¾‹è°ƒæ•´é«˜åº¦ */
            z-index: 20;
            pointer-events: none;
            opacity: 0.5;
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, top 0.5s ease;
        }

        .toast-top {
            top: 20px;
            background-color: #ff4c4c;
        }

        .toast-bottom {
            bottom: 20px;
            background-color: #ff4c4c;
        }

        .toast.show {
            opacity: 1;
        }

        /* é’ˆå¯¹iPhone 14ï¼ˆå±å¹•å®½åº¦çº¦430pxï¼‰ */
        @media (max-width: 430px) {
            .play-icon {
                width: 20vw;
                /* iPhone 14 å±å¹•ä¸Šä½¿ç”¨è§†å£å®½åº¦çš„20% */
            }

            .slide-list {
                width: 56.25vh;
            }
        }

        /* éŸ³é‡æŒ‰é’®æ ·å¼ */
        .mute-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #3d3dc0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s;
            z-index: 10;
        }

        .mute-toggle.muted {
            background-color: #e95e5e;
            /* å½“é™éŸ³æ—¶æŒ‰é’®ä¸ºçº¢è‰² */
        }

        .mute-icon {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="slide-list" style="top: -100%;">
        <div class="frame">
            <video src="" muted loop preload="auto" playsinline></video>
        </div>
        <div class="frame watching">
            <video src="" muted loop preload="auto" playsinline></video>
        </div>
        <div class="frame">
            <video src="" muted loop preload="auto" playsinline></video>
        </div>
    </div>
    <img src="./play.png" class="play-icon" alt="Play Icon">
    <div class="mute-toggle muted" id="muteButton">
        <span id="muteIcon" class="mute-icon">ğŸ”‡</span>
    </div>
    <script>

        function showToast(message, position = 'top') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${position}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // å¼ºåˆ¶è§¦å‘é‡ç»˜ä»¥æ¿€æ´»åŠ¨ç”»
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                toast.classList.remove('show');
                toast.style[position] = '-50px'; // å‘ä¸Šæˆ–å‘ä¸‹ç§»åŠ¨æç¤ºæ¡†
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            }, 1000);
        }

        function updateSlidePosition(index) {
            slideList.style.transform = `translateY(-${index * 100}%)`;
        }

        async function playVideo(videoElement) {
            try {
                await videoElement.play();
                isPaused = false;
                checkPlayIcon();
            } catch (error) {
                console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', error);

                // è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚æç¤ºç”¨æˆ·
                if (error.name === 'NotAllowedError') {
                    isPaused = true;
                    checkPlayIcon();
                }
            }
        }

        async function nextVideo() {
            if (vpointer == videoList.length - 1) {
                // è¯·æ±‚æ‹‰å–æ–°è§†é¢‘
                if (await getVideos() === 'noMore') {
                    showToast('æ²¡æœ‰æ›´å¤šè§†é¢‘äº†ï¼', 'bottom');
                    console.log('æ²¡æœ‰æ›´å¤šè§†é¢‘äº†');
                    return;
                }
            }

            //åˆ·æ–°å½“å‰è§†é¢‘å’Œå³å°†æ’­æ”¾çš„è§†é¢‘çŠ¶æ€
            const slideList = document.querySelector('.slide-list');
            const watchingFrame = document.querySelector('.frame.watching');
            const video = watchingFrame.querySelector('video');
            video.pause();
            watchingFrame.classList.remove('watching');

            // è·å–æœ€åä¸€ä¸ª frame
            const lastFrame = slideList.lastElementChild;
            lastFrame.classList.add('watching');
            const lastVideo = lastFrame.querySelector('video');
            lastVideo.muted = isMuted;
            lastVideo.currentTime = 0;
            playVideo(lastVideo);


            // å¦‚æœç´¢å¼•æ›´æ–°ååœ¨è§†é¢‘åˆ—è¡¨èŒƒå›´å†…ï¼Œåˆ™ç›´æ¥æ»šåŠ¨ã€‚
            if (vpointer < videoList.length - 1) {
                vpointer++;

                updateSlidePosition(vpointer);
                console.log("å½“å‰ç´¢å¼•:", vpointer);
                console.log("å½“å‰æ’­æ”¾çš„è§†é¢‘:", videoList[vpointer])

                // å¦‚æœæ»šåŠ¨åçš„ä¸‹ä¸ªè§†é¢‘åœ¨è§†é¢‘åˆ—è¡¨èŒƒå›´å†…åˆ™ç›´æ¥ä¿®æ”¹dom
                if (videoList[vpointer + 1]) {
                    // è·å–ç¬¬ä¸€ä¸ª frame
                    const firstFrame = slideList.firstElementChild;
                    const firstVideo = firstFrame.querySelector('video');
                    firstVideo.src = API_BASE_URL + videoList[vpointer + 1] || "";
                    // å°†ç¬¬ä¸€ä¸ª frame ç§»åŠ¨åˆ° slide-list çš„æœ«å°¾
                    slideList.appendChild(firstFrame);
                    let currentTop = parseFloat(slideList.style.top);
                    const newTop = vpointer * 100 - 100;
                    // è®¾ç½®æ–°çš„ top å€¼
                    slideList.style.top = `${newTop}%`;
                } else {
                    // ä¸åœ¨è§†é¢‘åˆ—è¡¨å†…åˆ™é¢„åŠ è½½æ‹‰å–æ–°è§†é¢‘
                    await getVideos();
                    // è‹¥æ²¡æœ‰æ›´å¤šè§†é¢‘ï¼Œä¹Ÿéœ€è¦ç§»åŠ¨frameï¼Œå§‹ç»ˆè®©è§‚çœ‹çš„è§†é¢‘ä¿æŒåœ¨ä¸‰ä¸ªframeä¸­é—´ã€‚
                    // è·å–ç¬¬ä¸€ä¸ª frame
                    const firstFrame = slideList.firstElementChild;
                    const firstVideo = firstFrame.querySelector('video');
                    firstVideo.src = API_BASE_URL + videoList[vpointer + 1] || "";
                    // å°†ç¬¬ä¸€ä¸ª frame ç§»åŠ¨åˆ° slide-list çš„æœ«å°¾
                    slideList.appendChild(firstFrame);
                    let currentTop = parseFloat(slideList.style.top);
                    const newTop = vpointer * 100 - 100;
                    // è®¾ç½®æ–°çš„ top å€¼
                    slideList.style.top = `${newTop}%`;
                }
                console.log(`slideList.style.top = ${slideList.style.top}`);
            }

        }

        function prevVideo() {
            if (vpointer == 0) {
                console.log('åˆ°å¤´äº†');
                showToast('å·²ç»åˆ°é¡¶éƒ¨äº†ï¼', 'top');
                return;
            } else if (vpointer > 0) {
                vpointer--;
                const slideList = document.querySelector('.slide-list');
                const watchingFrame = document.querySelector('.frame.watching');
                const video = watchingFrame.querySelector('video');
                video.pause();
                watchingFrame.classList.remove('watching');

                // è·å–ç¬¬ä¸€ä¸ª frame
                const firstFrame = slideList.firstElementChild;
                firstFrame.classList.add('watching');
                const firstVideo = firstFrame.querySelector('video');
                firstVideo.muted = isMuted;
                firstVideo.currentTime = 0;
                playVideo(firstVideo);

                updateSlidePosition(vpointer);
                console.log("å½“å‰ç´¢å¼•:", vpointer);
                console.log("å½“å‰æ’­æ”¾çš„è§†é¢‘:", videoList[vpointer])

                // è·å–æœ€åä¸€ä¸ª frame
                const lastFrame = slideList.lastElementChild;
                const lastVideo = lastFrame.querySelector('video');

                // é¿å…ç”¨æˆ·å†æ¬¡ä¸Šæ»‘æ—¶ç´¢å¼•ä¸º-1æµè§ˆå™¨æŠ¥é”™ï¼Œå¯æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ã€‚
                lastVideo.src = API_BASE_URL + videoList[vpointer - 1] || "";
                // å°†æœ€åä¸€ä¸ª frame ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ª frame å‰
                slideList.insertBefore(lastFrame, firstFrame);
                let currentTop = parseFloat(slideList.style.top);
                const newTop = vpointer * 100 - 100;
                // è®¾ç½®æ–°çš„ top å€¼
                slideList.style.top = `${newTop}%`;
                console.log(`slideList.style.top = ${slideList.style.top}`);
            }
        }

        function checkPlayIcon() {
            playIcon.style.display = isPaused ? 'block' : 'none';
        }

        function togglePlayPause() {
            const watchingFrame = document.querySelector('.frame.watching');
            const video = watchingFrame.querySelector('video');

            if (video.paused) {
                video.play(); // æ’­æ”¾è§†é¢‘
                isPaused = false;
                console.log('è§†é¢‘æ’­æ”¾');
            } else {
                video.pause(); // æš‚åœè§†é¢‘
                isPaused = true;
                console.log('è§†é¢‘æš‚åœ');
            }
            checkPlayIcon();
        }


        /**
         * åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯
         * @returns {Promise<string>} è¿”å›æ–°çš„ UUIDï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ° sessionStorage
         */
        async function createSession() {
            try {
                const response = await fetch(`${API_BASE_URL}/create-session`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    throw new Error(`åˆ›å»ºä¼šè¯å¤±è´¥: ${response.statusText}`);
                }

                const data = await response.json();

                console.log(data.uuid);

                // å°† UUID å­˜å‚¨åˆ° sessionStorage
                sessionStorage.setItem("sessionUUID", data.uuid);

                return data.uuid;
            } catch (error) {
                console.error("åˆ›å»ºä¼šè¯æ—¶å‡ºé”™:", error);
                throw error;
            }
        }

        /**
         * è·å–æ¨èè§†é¢‘
         * @returns {Promise<Object>} è¿”å›åŒ…å«è§†é¢‘åˆ—è¡¨å’Œæ¶ˆæ¯çš„å¯¹è±¡
         */
        async function getVideos() {
            console.log("æ­£åœ¨è·å–æ–°è§†é¢‘");
            uuid = sessionStorage.getItem("sessionUUID");
            try {
                const response = await fetch(`${API_BASE_URL}/get-videos`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ uuid }),
                });

                if (!response.ok) {
                    throw new Error(`è·å–è§†é¢‘å¤±è´¥: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.message === "noMore") {
                    return data.message;
                } else {
                    // å°†è·å–åˆ°çš„è§†é¢‘è¿½åŠ åˆ° videoList ä¸­
                    videoList.push(...data.videos); // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦è¿½åŠ 
                    console.log("å½“å‰è§†é¢‘åˆ—è¡¨:", videoList);
                    return data.message;
                }
            } catch (error) {
                console.error("è·å–è§†é¢‘æ—¶å‡ºé”™:", error);
                throw error;
            }
        }


        const API_BASE_URL = "http://127.0.0.1:8000";

        let videoList = []
        let vpointer = 0; // å½“å‰æ˜¾ç¤ºè§†é¢‘çš„ç´¢å¼•
        let isMuted = true; // é»˜è®¤é™éŸ³
        let isPaused = true; // é»˜è®¤æš‚åœ

        // ç¼“å­˜ DOM å…ƒç´ 
        const slideList = document.querySelector('.slide-list');
        const playIcon = document.querySelector('.play-icon');
        const muteButton = document.getElementById('muteButton');
        const muteIcon = document.getElementById('muteIcon');

        muteButton.addEventListener('click', toggleMute);

        function toggleMute() {
            const watchingFrame = document.querySelector('.frame.watching');
            const video = watchingFrame.querySelector('video');

            if (isMuted) {
                video.muted = false;
                isMuted = false;
                muteButton.classList.remove('muted');
                muteIcon.textContent = 'ğŸ”Š';  // æ˜¾ç¤ºéŸ³é‡å›¾æ ‡
                console.log('å–æ¶ˆé™éŸ³');
            } else {
                video.muted = true;
                isMuted = true;
                muteButton.classList.add('muted');
                muteIcon.textContent = 'ğŸ”‡';  // æ˜¾ç¤ºé™éŸ³å›¾æ ‡
                console.log('é™éŸ³');
            }
        }

        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i.test(navigator.userAgent);
        }

        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }


        //é¡µé¢é¦–æ¬¡åŠ è½½åˆå§‹åŒ–
        async function initialize() {



            window.addEventListener('resize', setViewportHeight);
            setViewportHeight();

            await createSession();
            await getVideos();

            const watchingFrame = document.querySelector('.frame.watching');
            const video = watchingFrame.querySelector('video');
            video.src = API_BASE_URL + videoList[vpointer];
            window.console.log("å½“å‰ç´¢å¼•:", vpointer);
            console.log("å½“å‰æ’­æ”¾çš„è§†é¢‘:", videoList[vpointer])
            const slideList = document.querySelector('.slide-list');
            const lastFrame = slideList.lastElementChild;
            const lastVideo = lastFrame.querySelector('video');
            lastVideo.src = API_BASE_URL + videoList[vpointer + 1];
            playVideo(video);

            if (isMobileDevice()) {

                //å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡è®¿é—®ï¼Œåˆ™é»˜è®¤å–æ¶ˆé™éŸ³ã€‚
                // toggleMute();
                //checkPlayIcon();

                // ç›‘å¬è§¦æ‘¸æ»‘åŠ¨äº‹ä»¶
                let touchStartY = 0;
                let touchEndY = 0;

                document.addEventListener('touchstart', (e) => {
                    console.log('touchstart', e.touches[0].clientY); // æ·»åŠ æ—¥å¿—
                    touchStartY = e.touches[0].clientY;
                });

                document.addEventListener('touchend', (e) => {
                    console.log('touchend', e.changedTouches[0].clientY);
                    touchEndY = e.changedTouches[0].clientY;
                    if (touchStartY - touchEndY > 50) {
                        nextVideo(); // å‘ä¸Šæ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘
                    } else if (touchEndY - touchStartY > 50) {
                        prevVideo(); // å‘ä¸‹æ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘
                    }
                });

            } else {

                // ç›‘å¬æ–¹å‘é”®æŒ‰ä¸‹äº‹ä»¶
                document.addEventListener('keydown', (event) => {
                    if (event.code === "ArrowDown") {
                        // ä¸‹ç®­å¤´ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘
                        nextVideo();
                    } else if (event.code === "ArrowUp") {
                        // ä¸Šç®­å¤´ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘
                        prevVideo();
                    } else if (event.code === "KeyM") {
                        toggleMute();
                    } else if (event.code === 'Space') {
                        togglePlayPause();
                    }
                });

                // ç›‘å¬æ»šè½®äº‹ä»¶
                document.addEventListener('wheel', (event) => {
                    if (event.deltaY > 0) {
                        // å‘ä¸‹æ»šåŠ¨ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘
                        nextVideo();
                    } else if (event.deltaY < 0) {
                        // å‘ä¸Šæ»šåŠ¨ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘
                        prevVideo();
                    }
                });
            }

            // æ·»åŠ ç‚¹å‡»æš‚åœå’Œæ’­æ”¾åŠŸèƒ½
            document.querySelector('.slide-list').addEventListener('click', (event) => {
                togglePlayPause(); // è°ƒç”¨ togglePlayPause å‡½æ•°
            });

            if (isMuted) {
                muteButton.classList.add('muted');
                muteIcon.textContent = 'ğŸ”‡';
            } else {
                muteButton.classList.remove('muted');
                muteIcon.textContent = 'ğŸ”Š';
            }

        }

        initialize();

    </script>
</body>

</html>